name: Generate Release Assets (DuckDB C libs)

on:
  release:
    types: [published]

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Define target folders 📁
        id: folders
        run: |
          echo "folders=linux-amd64 linux-arm64 osx-universal windows-amd64 windows-arm64" >> $GITHUB_OUTPUT

      - name: Compress and Upload Assets 🚀
        run: |
          RELEASE_ID=${{ github.event.release.id }}
          
          for FOLDER in ${{ steps.folders.outputs.folders }}; do
            ASSET_NAME="${FOLDER}.zip"
            FILE_PATH="./lib/${FOLDER}"
            ZIP_PATH="./${ASSET_NAME}"
          
            echo "Processing folder: ${FOLDER}"
          
            zip -r -j -9 "${ZIP_PATH}" "${FILE_PATH}"
          
            if [ -f "${ZIP_PATH}" ]; then
              echo "Successfully created ${ASSET_NAME}"
              echo "Uploading ${ASSET_NAME}..."
              gh asset upload "${ZIP_PATH}" --repo "${{ github.repository }}" --release-id "${RELEASE_ID}" --clobber
          
              echo "Upload of ${ASSET_NAME} complete."
            else
              echo "Error: Failed to create ${ASSET_NAME}"
              exit 1
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
